# Feature Specification: プロジェクト予算管理システム

**Feature Branch**: `feature/project-budget-management`  
**Created**: 2025-10-11  
**Status**: Draft  
**Input**: User description: "ソフトウェア開発の工数の予実を管理して収支管理をするアプリを作りたい。複数プロジェクトの管理と、グラフ化をしたい。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - プロジェクトの登録と基本情報管理 (Priority: P1)

ユーザーは新しいソフトウェア開発プロジェクトを登録し、プロジェクト名、予算、期間、担当メンバーなどの基本情報を管理できる。

**Why this priority**: プロジェクトの基本情報管理は全ての機能の基盤となるため、最優先で実装する必要がある。この機能がなければ工数や収支の管理ができない。

**Independent Test**: プロジェクト一覧画面で新規プロジェクトを作成し、プロジェクト詳細画面で情報を表示・編集できることを確認することで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** ユーザーがログインしている, **When** 新規プロジェクト作成ボタンをクリックして必要情報を入力し保存, **Then** プロジェクトが作成されプロジェクト一覧に表示される
2. **Given** プロジェクトが存在する, **When** プロジェクト詳細画面で情報を編集し保存, **Then** 更新された情報が反映される
3. **Given** プロジェクト一覧画面を表示, **When** 検索・フィルタ機能を使用, **Then** 条件に合致するプロジェクトのみが表示される

---

### User Story 2 - 工数の予定・実績入力と管理 (Priority: P1)

ユーザーは各プロジェクトに対して工数の予定（計画）と実績を入力・管理でき、予実差異を確認できる。

**Why this priority**: 予実管理の核心機能であり、この機能がなければアプリの主目的を達成できない。P1として最初のMVPに含める。

**Independent Test**: 特定のプロジェクトを選択し、タスクや作業項目に対して予定工数と実績工数を入力し、予実比較画面で差異を確認できることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** プロジェクトが選択されている, **When** タスクを作成し予定工数を入力, **Then** タスク一覧に予定工数が表示される
2. **Given** タスクに予定工数が登録されている, **When** 実績工数を入力, **Then** 予実差異が自動計算され表示される
3. **Given** 複数のタスクが存在する, **When** プロジェクト全体の予実サマリーを表示, **Then** 全タスクの合計予定工数・実績工数・差異が表示される
4. **Given** 実績工数が予定を超過している, **When** 予実画面を確認, **Then** 超過分が警告色で表示される

---

### User Story 3 - 収支管理（売上・コスト） (Priority: P1)

ユーザーはプロジェクトの売上（受注金額）とコスト（人件費等）を管理し、利益を算出できる。

**Why this priority**: 工数管理と並ぶ主要機能であり、プロジェクトの収益性を評価するために必須。初期MVPに含める。

**Independent Test**: プロジェクトの売上金額と単価設定を入力し、工数実績に基づいたコスト計算と利益計算が正しく行われることを確認することで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** プロジェクトが作成されている, **When** 売上金額（受注額）を入力, **Then** プロジェクト詳細に売上が表示される
2. **Given** メンバーごとの単価（時間単価）が設定されている, **When** 実績工数が入力される, **Then** コストが自動計算される（工数 × 単価）
3. **Given** 売上とコストが登録されている, **When** 収支サマリーを表示, **Then** 利益（売上 - コスト）と利益率が表示される
4. **Given** プロジェクトが赤字の場合, **When** 収支画面を確認, **Then** 赤字金額が警告表示される

---

### User Story 4 - 複数プロジェクトの一覧管理とダッシュボード (Priority: P2)

ユーザーは複数のプロジェクトを一覧で管理し、各プロジェクトの状況を横断的に確認できるダッシュボードを利用できる。

**Why this priority**: 複数プロジェクトを管理する組織にとって重要だが、単一プロジェクトでも基本機能は利用可能なため、P2とする。

**Independent Test**: 複数のプロジェクトを作成し、ダッシュボード画面で全プロジェクトのサマリー（予算達成率、利益率など）を一覧表示できることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 複数のプロジェクトが存在する, **When** ダッシュボードにアクセス, **Then** 全プロジェクトの一覧とKPI（工数達成率、利益率など）が表示される
2. **Given** ダッシュボードを表示, **When** プロジェクトをステータス（進行中、完了、保留など）でフィルタ, **Then** 該当するプロジェクトのみが表示される
3. **Given** ダッシュボードを表示, **When** KPIでソート（利益率順など）, **Then** 指定した順序でプロジェクトが並び替えられる

---

### User Story 5 - グラフ・チャートによる可視化 (Priority: P2)

ユーザーはプロジェクトの予実、収支、進捗などをグラフやチャートで視覚的に確認できる。

**Why this priority**: データの可視化は意思決定を支援する重要な機能だが、数値データだけでも運用可能なため、P2とする。

**Independent Test**: プロジェクトデータが登録されている状態で、各種グラフ（棒グラフ、折れ線グラフ、円グラフなど）を表示し、データが正しく反映されていることを確認することで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** プロジェクトに予実データが存在する, **When** 予実グラフを表示, **Then** 予定と実績が棒グラフまたは折れ線グラフで比較表示される
2. **Given** 複数のプロジェクトが存在する, **When** 収支グラフを表示, **Then** 各プロジェクトの利益/損失が棒グラフで表示される
3. **Given** 時系列データが存在する, **When** 月別の推移グラフを表示, **Then** 工数や収支の月次推移が折れ線グラフで表示される
4. **Given** プロジェクト内にタスクがある, **When** タスク別工数の円グラフを表示, **Then** 各タスクの工数割合が円グラフで表示される

---

### User Story 6 - メンバー・リソース管理 (Priority: P3)

ユーザーはプロジェクトメンバーを登録・管理し、各メンバーの稼働状況や単価を管理できる。

**Why this priority**: より詳細な管理を可能にする機能だが、基本的な工数・収支管理は人単位でなくても可能なため、P3とする。

**Independent Test**: メンバーを登録し、各メンバーに単価を設定、プロジェクトへのアサイン、メンバー別の稼働レポートを表示できることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 管理者権限がある, **When** 新規メンバーを登録し単価を設定, **Then** メンバー一覧に追加される
2. **Given** メンバーが登録されている, **When** プロジェクトにメンバーをアサイン, **Then** プロジェクトメンバー一覧に表示される
3. **Given** メンバーに実績工数が記録されている, **When** メンバー別稼働レポートを表示, **Then** 各メンバーの総稼働時間とコストが表示される
4. **Given** メンバーが複数プロジェクトにアサインされている, **When** リソース稼働状況を表示, **Then** メンバーの稼働率が確認できる

---

### User Story 7 - データのエクスポート・レポート出力 (Priority: P3)

ユーザーはプロジェクトデータをCSVやPDF形式でエクスポートし、レポートとして出力できる。

**Why this priority**: 外部での利用や報告に便利だが、画面上での確認でも運用可能なため、P3とする。

**Independent Test**: プロジェクトデータをCSV/PDF形式でエクスポートし、出力されたファイルにデータが正しく含まれていることを確認することで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** プロジェクトデータが存在する, **When** CSV形式でエクスポートを実行, **Then** プロジェクト情報・予実データを含むCSVファイルがダウンロードされる
2. **Given** プロジェクト詳細画面を表示, **When** PDFレポート出力を実行, **Then** グラフを含む見栄えの良いPDFレポートが生成される
3. **Given** ダッシュボードを表示, **When** 全プロジェクトのサマリーをエクスポート, **Then** 全プロジェクトの集計データがCSVで出力される

---

### Edge Cases

- プロジェクトに工数データが全く登録されていない場合、グラフや予実画面はどう表示するか？
  - 空のグラフまたは「データがありません」メッセージを表示
- 実績工数が予定工数を大幅に超過した場合の表示や警告は？
  - 超過率に応じて色分け表示（例：20%超過で黄色、50%超過で赤色）
- 売上が未入力の場合、収支計算はどう扱うか？
  - 売上を0として利益を計算、または「売上未登録」として表示
- 複数通貨を扱う場合は？
  - 初期バージョンでは単一通貨（JPY）のみサポート、将来的に拡張可能な設計にする
- プロジェクトが削除された場合、関連データ（工数、収支）はどうなるか？
  - 論理削除（アーカイブ）として扱い、復元可能にする
- 同時編集時のデータ整合性は？
  - 楽観的ロックまたはタイムスタンプベースの競合検出を実装
- メンバーの単価変更が過去のデータに影響を与えるか？
  - 単価履歴を保持し、工数記録時点の単価を使用する
- 大量のプロジェクト（100件以上）がある場合のパフォーマンスは？
  - ページネーション、遅延読み込み、インデックス最適化で対応

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはプロジェクトの作成・編集・削除（論理削除）ができなければならない
- **FR-002**: システムはプロジェクトごとに予算、期間、ステータス、説明を記録できなければならない
- **FR-003**: システムはプロジェクト内のタスク/作業項目を管理できなければならない
- **FR-004**: システムはタスクごとに予定工数（時間単位）を登録できなければならない
- **FR-005**: システムはタスクごとに実績工数（時間単位）を登録できなければならない
- **FR-006**: システムは予定工数と実績工数の差異を自動計算して表示しなければならない
- **FR-007**: システムはプロジェクトの売上金額を登録できなければならない
- **FR-008**: システムはメンバーごとの時間単価を管理できなければならない
- **FR-009**: システムは実績工数と単価からコストを自動計算しなければならない
- **FR-010**: システムは売上からコストを差し引いた利益を自動計算しなければならない
- **FR-011**: システムは複数のプロジェクトを一覧表示できなければならない
- **FR-012**: システムはプロジェクトをステータス、期間、利益率などでフィルタ・ソートできなければならない
- **FR-013**: システムは予実データを棒グラフまたは折れ線グラフで可視化できなければならない
- **FR-014**: システムは収支データを棒グラフで可視化できなければならない
- **FR-015**: システムはタスク別工数の割合を円グラフで表示できなければならない
- **FR-016**: システムは月次または期間別の推移を折れ線グラフで表示できなければならない
- **FR-017**: システムは工数超過時に視覚的な警告表示を行わなければならない
- **FR-018**: システムは赤字プロジェクトを視覚的に強調表示しなければならない
- **FR-019**: システムはダッシュボードで全プロジェクトのKPI（工数達成率、利益率など）を表示しなければならない
- **FR-020**: システムはデータをCSV形式でエクスポートできなければならない
- **FR-021**: システムはユーザー認証機能を提供しなければならない [NEEDS CLARIFICATION: 認証方式 - 独自認証、OAuth、SSO等]
- **FR-022**: システムは複数ユーザーのアクセス権限を管理できなければならない [NEEDS CLARIFICATION: 権限レベル - 閲覧者、編集者、管理者等の定義]
- **FR-023**: システムは日時データをユーザーのタイムゾーンに応じて表示しなければならない [NEEDS CLARIFICATION: 対応タイムゾーンの範囲]
- **FR-024**: システムは入力データのバリデーションを行い、不正な値を拒否しなければならない

### Key Entities

- **Project（プロジェクト）**: ソフトウェア開発プロジェクトを表す。属性には名称、開始日、終了日、予算、ステータス（計画中、進行中、完了、保留など）、説明、作成日時、更新日時が含まれる。Taskと1対多、Memberと多対多の関係を持つ。

- **Task（タスク/作業項目）**: プロジェクト内の作業単位を表す。属性には名称、説明、予定工数（時間）、実績工数（時間）、担当者、開始日、終了日、ステータスが含まれる。Projectに属し、1つのProjectは複数のTaskを持つ。

- **Member（メンバー）**: プロジェクトに参加する人員を表す。属性には名前、メールアドレス、役割、時間単価、所属部署が含まれる。複数のProjectに参加でき、Projectと多対多の関係を持つ。

- **Budget（予算）**: プロジェクトの収支情報を表す。属性には売上金額、総コスト（計算値）、利益（計算値）、利益率（計算値）が含まれる。Projectと1対1の関係を持つ。

- **TimeEntry（工数記録）**: 実績工数の詳細記録を表す。属性には日付、工数（時間）、担当者、タスク、コメントが含まれる。TaskとMemberに紐づく。

- **ProjectMember（プロジェクトメンバー割り当て）**: ProjectとMemberの多対多関係を管理する中間エンティティ。属性には参加日、離脱日、割り当て率（専任度）、その時点での単価が含まれる。

- **Chart/Graph（グラフ設定）**: 表示するグラフの設定を表す。属性にはグラフタイプ（棒、折れ線、円など）、対象データ、期間、フィルタ条件が含まれる。永続化は必須ではなく、UIステートとして扱う可能性もある。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは5分以内に新規プロジェクトを作成し、基本情報を登録できる
- **SC-002**: ユーザーは3クリック以内でプロジェクトの予実差異を確認できる
- **SC-003**: ユーザーは2クリック以内でプロジェクトの収支（利益/損失）を確認できる
- **SC-004**: ダッシュボードは50件のプロジェクトを2秒以内に表示できる
- **SC-005**: グラフは100件のデータポイントを3秒以内に描画できる
- **SC-006**: 90%のユーザーが初回利用時にトレーニングなしで工数入力ができる
- **SC-007**: プロジェクトマネージャーの予実確認時間を50%削減する
- **SC-008**: 収支管理の手作業をなくし、リアルタイムで利益計算が可能になる
- **SC-009**: システムの可用性は99%以上を維持する
- **SC-010**: データのエクスポート機能により、月次レポート作成時間を70%削減する

## Technical Considerations

### Recommended Technology Stack

#### フロントエンド
- **フレームワーク**: React または Vue.js（コンポーネントベースのUI構築に適している）
- **グラフライブラリ**: Chart.js、Recharts、または D3.js（多様なグラフ表示に対応）
- **状態管理**: Redux、Zustand、または Pinia（複雑なアプリケーション状態の管理）
- **UIコンポーネント**: Material-UI、Ant Design、または Tailwind CSS（迅速なUI開発）
- **UIフレームワーク**: shadcn/uiを用いる(モダンなデザイン)

#### バックエンド
- **言語・フレームワーク**: 
  - Go + Echo
  - ORMはGormを用いる
- **API設計**: RESTful API または GraphQL

#### データベース
- **リレーショナルDB**: PostgreSQL または MySQL（複雑なリレーション、トランザクション管理）
- **ORM**: Prisma、TypeORM、または SQLAlchemy（データモデル管理の簡素化）

#### 認証・セキュリティ
- JWT（JSON Web Token）による認証
- OAuth 2.0対応（将来的な拡張）
- HTTPS通信の必須化
- CORS設定の適切な管理

#### デプロイ・インフラ
- **ホスティング**: Vercel、Netlify（フロントエンド）、AWS、GCP、Azure（バックエンド）
- **コンテナ化**: Docker（環境の一貫性）
- **CI/CD**: GitHub Actions、GitLab CI（自動テスト・デプロイ）

### Data Model Considerations

- プロジェクト、タスク、メンバーの関係は多対多のため、中間テーブル（ProjectMember、TaskAssignment）が必要
- 単価の履歴管理のため、TimeEntryに記録時点の単価をスナップショットとして保存
- 論理削除のため、各エンティティに`deleted_at`フィールドを持たせる
- 監査ログのため、`created_at`、`updated_at`、`created_by`、`updated_by`を保持
- 通貨対応のため、金額フィールドには通貨コード（ISO 4217）を併記可能にする

### Performance Considerations

- プロジェクト一覧のページネーション実装（1ページあたり20-50件）
- グラフデータの集計クエリ最適化（インデックス、集計関数の活用）
- フロントエンドでのデータキャッシング（React Query、SWR等）
- 大量データ表示時の仮想スクロール（react-window、react-virtualized）
- APIレスポンスの圧縮（gzip）

### Security Considerations

- パスワードのハッシュ化（bcrypt、Argon2）
- SQLインジェクション対策（パラメータ化クエリ、ORM使用）
- XSS対策（入力のサニタイズ、CSP設定）
- CSRF対策（トークン検証）
- レート制限（API呼び出しの制限）
- ロールベースアクセス制御（RBAC）

### Scalability Considerations

- 水平スケーリング可能なアーキテクチャ設計
- ステートレスなAPIサーバー設計
- データベース接続プーリング
- 静的ファイルのCDN配信
- キャッシュ層の導入（Redis等）検討

## Out of Scope（初期バージョンでは対象外）

- モバイルアプリ（iOS/Android）
- リアルタイムコラボレーション機能（複数ユーザーの同時編集表示）
- 高度な予測・分析機能（機械学習による工数予測など）
- 外部ツール連携（Jira、GitHub、Slack等）
- 多言語対応（初期は日本語のみ）
- 複数通貨・為替レート管理
- 細かい権限管理（閲覧のみ、編集のみなどの詳細な権限）
- 監査ログの詳細表示UI
- ガントチャートによるスケジュール管理
- リソースの稼働予測・最適化機能

## Questions for Clarification

1. **ユーザー数の想定**: 同時利用ユーザー数、総登録ユーザー数の想定は？（スケーラビリティ設計に影響）
2. **認証方式**: 独自のユーザー登録/ログイン機能が必要か、それとも既存の認証システム（SSO、OAuth）との連携が必要か？
3. **アクセス権限**: プロジェクトごとにアクセス権限を設定する必要があるか？（閲覧のみ、編集可能、管理者など）
4. **データ保持期間**: 完了したプロジェクトのデータをどれくらいの期間保持するか？
5. **バックアップ要件**: データのバックアップ頻度や復旧時間の要件は？
6. **通知機能**: 工数超過や予算超過時のメール/プッシュ通知は必要か？
7. **カスタマイズ**: グラフの種類や表示項目のカスタマイズ機能は必要か？
8. **エクスポート形式**: CSV以外の形式（Excel、JSON等）のエクスポートは必要か？
9. **インポート機能**: 既存データのCSVインポート機能は必要か？
10. **承認フロー**: 工数入力や予算変更に承認プロセスは必要か？
11. **モバイル対応**: レスポンシブWebデザインでのモバイル対応は必要か？それともデスクトップのみか？
12. **オフライン対応**: オフライン時のデータ入力と同期機能は必要か？

## Next Steps

1. **仕様の確認**: 上記の質問事項について回答をいただき、仕様を明確化
2. **技術スタックの決定**: プロジェクトの要件に基づいて具体的な技術スタックを選定
3. **データモデル設計**: ERダイアグラムの作成とデータベーススキーマ設計
4. **ワイヤーフレーム作成**: 主要画面（ダッシュボード、プロジェクト詳細、予実管理、グラフ表示）のUI設計
5. **アーキテクチャ設計**: システム全体のアーキテクチャ図作成
6. **開発計画**: イテレーションごとの実装計画策定（P1 → P2 → P3の順）
7. **プロトタイプ開発**: P1機能のMVP開発開始
